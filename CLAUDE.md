# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a full-stack web application template built with:
- **Frontend**: Vanilla JavaScript/HTML/CSS (no build process)
- **Backend**: Supabase Edge Functions (Deno runtime)
- **Database**: PostgreSQL via Supabase
- **Hosting**: Cloudflare Pages (frontend), Supabase (backend)
- **Users**: Email-based user identification (no passwords or authentication)
- **AI/LLM**: OpenAI API integration (required)

## Key Commands

```bash
# Initial setup (run once)
cp env.config.template env.config
# Edit env.config with your Supabase and Cloudflare credentials
source setup-env.sh

# Database setup
./setup_database.sh

# Deploy backend (Supabase Edge Functions)
./deploy_backend.sh

# Deploy frontend (Cloudflare Pages)
./deploy_frontend.sh

# Deploy specific function
supabase functions deploy <function-name> --project-ref $SUPABASE_PROJECT_REF
```

## âš ï¸ Most Common Error

**If you see "Missing Supabase configuration" or similar errors:**
1. Make sure `env.js` exists (created by deploy_frontend.sh)
2. Make sure `env.js` is loaded FIRST in your HTML (before all other scripts)
3. See "Script Loading Order" section below for details

## Architecture

### Directory Structure
```
template/
â”œâ”€â”€ frontend/               # Frontend application
â”‚   â”œâ”€â”€ index.html         # Main application (shows after login)
â”‚   â”œâ”€â”€ login.html         # Login page (email entry only, no password)
â”‚   â”œâ”€â”€ index.js           # Main app logic
â”‚   â”œâ”€â”€ user.js            # User management (email storage)
â”‚   â”œâ”€â”€ supabase.js        # Supabase client
â”‚   â”œâ”€â”€ style.css          # Styles
â”‚   â””â”€â”€ env.js             # Environment variables (generated)
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ functions/         # Edge functions
â”‚   â”‚   â”œâ”€â”€ _shared/       # Shared utilities
â”‚   â”‚   â”‚   â””â”€â”€ cors.ts    # CORS configuration
â”‚   â”‚   â”œâ”€â”€ hello-world/   # Example public endpoint
â”‚   â”‚   â””â”€â”€ user-endpoint/  # Example user data endpoint
â”‚   â””â”€â”€ config.toml        # Supabase configuration
â”œâ”€â”€ sql/
â”‚   â””â”€â”€ schema.sql         # Database schema
â”œâ”€â”€ deploy_backend.sh      # Backend deployment script
â”œâ”€â”€ deploy_frontend.sh     # Frontend deployment script
â”œâ”€â”€ setup-env.sh           # Environment setup script
â”œâ”€â”€ env.config.template    # Configuration template
â”œâ”€â”€ CLAUDE.md             # This file
â””â”€â”€ README.md             # Setup instructions
```

### Page Structure

**Application Pages:**
- `login.html` - Email entry page (users enter email, no password)
- `index.html` - Main application (shows after user enters email)

**User Flow:**
1. User visits site â†’ redirected to login.html if no email stored
2. User enters email (no password required) â†’ stored in localStorage
3. User redirected to index.html (main app)
4. All data is associated with user's email

## ğŸ“ Frontend File Strategy

**IMPORTANT: Always modify existing files instead of creating new ones!**

When users ask you to build features:
- âœ… **ALWAYS modify `index.html`** - This is the main app, put ALL features here
- âœ… **ALWAYS modify `index.js`** - All JavaScript logic goes here
- âœ… **NEVER create new HTML files** (no app.html, dashboard.html, etc.)
- âœ… **NEVER create new JS files** (no app.js, utils.js, etc.)
- âœ… Update schema.sql for database changes
- âœ… Create edge functions for backend logic

**Why?** The template is designed as a single-page application. Creating new files breaks the routing and user management. Everything should be added to the existing index.html/js files.

**Test Setup Flow:**
The template includes a comprehensive test section in the dashboard to verify:
1. Frontend deployment is working
2. Database connection (tests items table access)
3. Edge functions (both public and user endpoints)
4. LLM integration (tests OpenAI API connection)

All tests must pass before building custom features. The OpenAI API key is automatically configured from setup-env.sh.

### CRITICAL: The env.js File

**IMPORTANT**: The app requires `env.js` to be present with Supabase configuration. This file is:
- Generated by `deploy_frontend.sh` 
- Contains `window.SUPABASE_URL` and `window.SUPABASE_ANON_KEY`
- Required for the app to connect to Supabase

**If the user reports Supabase errors**, check if env.js exists:
```javascript
// env.js should contain:
window.SUPABASE_URL = 'https://xyzabc.supabase.co';
window.SUPABASE_ANON_KEY = 'eyJ...';
```

**For local development**, create env.js manually or run the deploy script.

### Key Patterns

1. **User Management**
   - User enters email on login page (login.html)
   - Email stored in localStorage (no password)
   - Users redirected to login.html if no email found
   - Can change email via settings in the app
   - No passwords or authentication required
   - All data associated with user's email

2. **Frontend Patterns**
   - Modular JavaScript with clear separation of concerns
   - Global auth state management via window.authReady
   - Event-driven communication between modules
   - Realtime subscriptions for live updates
   - No build process - pure vanilla JS

3. **Backend Patterns**
   - Edge functions follow consistent structure
   - CORS handling in _shared/cors.ts
   - Authentication verification via JWT
   - Proper error responses with status codes
   - Admin client for privileged operations

4. **Database Patterns**
   - UUID primary keys
   - Row Level Security (RLS) policies (open access, no auth checks)
   - Audit fields (created_at, updated_at)
   - user_email field for data ownership
   - Soft delete pattern where appropriate
   - **Idempotent schema**: setup_database.sh drops and recreates tables

5. **Security Best Practices**
   - Never expose API keys in frontend
   - Use environment variables for secrets
   - Implement RLS policies for all tables
   - Verify authentication in edge functions
   - Use admin client only when necessary

### âš ï¸ CRITICAL: Script Loading Order in HTML Files

**THIS IS THE #1 CAUSE OF ERRORS - env.js MUST BE LOADED FIRST!**

Always include scripts in this exact order:
```html
<!-- At the bottom of your HTML file, before </body> -->
<script src="env.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="user.js"></script>
<script src="index.js"></script>  <!-- or your page-specific script -->
```

**Why this order matters:**
1. `env.js` - Sets up environment variables (MUST be first)
2. Supabase CDN - Provides the Supabase library
3. `supabase.js` - Creates the Supabase client
4. `user.js` - Sets up user management
5. Your app logic - Can now use everything above

### Adding New Features

1. **New Page (rarely needed)**
   - Most features should be added to index.html
   - Only create new pages if specifically requested
   - Update user.js routing if adding pages

2. **New Edge Function**
   - Create folder in supabase/functions/
   - Copy structure from hello-world or user-endpoint
   - Import CORS from _shared/cors.ts
   - Deploy with deploy_backend.sh

3. **New Database Table**
   - Add to sql/schema.sql
   - Include RLS policies
   - Add indexes for performance
   - Enable realtime if needed

4. **Environment Variables**
   - Add to env.config
   - Document in README.md
   - Use in code via env.js (frontend) or Deno.env (backend)
   - OpenAI API key is automatically set as Edge Function secret

### IMPORTANT: About the "items" Table

The template includes a pre-built `items` table as an example. When building a new app:

**Option 1: Replace the items table (RECOMMENDED)**
- Remove the items table from schema.sql
- Create your own tables (e.g., todos, notes, posts)
- Update all references in the frontend
- This gives you a clean, purpose-built schema

**Option 2: Repurpose the items table**
- Keep the table but rename it in schema.sql
- Update the columns to match your needs
- Modify the frontend to use your new fields

**Option 3: Extend with new tables**
- Keep items as an example (can delete later)
- Add your new tables alongside it
- Build your features independently

### LLM Integration Pattern

The template includes a working OpenAI integration example in `test-llm` function:
- Accepts a prompt and user_email
- Calls OpenAI GPT-4.1
- Returns the AI response
- Handles errors gracefully

**To use this pattern in your own functions:**
1. Copy the `test-llm` function as a starting point
2. Modify the system prompt for your use case
3. Adjust max_tokens and temperature as needed
4. Add any additional context or parameters

### Common User Requests and How to Handle Them

1. **"Build a [todo/notes/task/etc] app"**
   - **First decision**: Replace or extend the items table (see above)
   - Modify `index.html` and `index.js` for the app UI
   - Update schema.sql with appropriate tables
   - Create edge functions for CRUD operations
   - Add realtime subscriptions if needed

2. **"Add user profiles"**
   - Create profiles table in schema.sql
   - Add RLS policies for security
   - Update index.html with profile UI
   - Create profile management edge functions

3. **"Add AI features"**
   - Use the existing OpenAI integration
   - Create edge functions that call LLMs
   - Add AI-powered UI to index.html
   - Example: AI chat, content generation, analysis

4. **"Add file uploads"**
   - Use Supabase Storage buckets
   - Create storage policies
   - Add upload UI to index.html
   - Handle file metadata in database

5. **"Add payment processing"**
   - Integrate Stripe via edge functions
   - Add subscription/payment tables
   - Create checkout flow in index.html
   - Handle webhooks securely

6. **"Make it real-time"**
   - Enable realtime on relevant tables
   - Add subscription handlers in index.js
   - Update UI reactively on changes

### Common Implementation Patterns

1. **Check User Status**
   ```javascript
   // Get current user email (redirects to login.html if not set)
   const userEmail = window.getCurrentUser();
   
   // User management is handled by user.js which:
   // - Checks localStorage for userEmail
   // - Redirects to login.html if not found
   // - Provides getCurrentUser() and logout() functions
   ```

2. **Make Authenticated API Call**
   ```javascript
   // Edge functions are available globally
   const result = await window.invokeEdgeFunction('your-function-name', { data: 'value' });
   ```

3. **Database Operations**
   ```javascript
   // All database functions are available globally
   const items = await window.selectFrom('items');
   const newItem = await window.insertInto('items', { name: 'New Item' });
   await window.updateIn('items', itemId, { name: 'Updated' });
   await window.deleteFrom('items', itemId);
   ```

4. **Subscribe to Realtime Updates**
   ```javascript
   const channel = window.subscribeToTable('items', (payload) => {
     console.log('Change:', payload);
     // Update UI based on change
   });
   ```

5. **Add RLS Policy**
   ```sql
   CREATE POLICY "Anyone can view items" ON items
     FOR SELECT USING (true);
   ```

### Testing

- Frontend: Use browser developer tools on deployed site
- Backend: Test via Supabase dashboard or curl commands
- Database: Use Supabase SQL editor for queries
- Authentication: Create test users via sign up form or Supabase dashboard
- Full Stack: Use the built-in test suite on the dashboard to verify setup

### Deployment

1. Always run `source setup-env.sh` before deploying
2. Deploy backend first with `./deploy_backend.sh`
3. Deploy frontend with `./deploy_frontend.sh`
4. Monitor logs in Supabase and Cloudflare dashboards

### Troubleshooting

- **Login issues**: Check localStorage for userEmail key
- **CORS errors**: Verify frontend URL in CORS configuration (update _shared/cors.ts)
- **Database errors**: Check that tables exist (run ./setup_database.sh) and RLS policies are open
- **Function 401/403 errors**: Ensure functions deployed with --no-verify-jwt flag
- **"Missing Supabase configuration"**: Check that env.js exists and is loaded first
- **OpenAI errors**: Verify API key is set and has active billing

# Important Claude Code Guidelines

1. **User Intent is King**
   - Build exactly what the user asks for
   - Don't add features they didn't request
   - Ask for clarification when needed

2. **File Management**
   - Edit existing files when possible
   - Only create new files for new features
   - Follow the established structure

3. **Communication**
   - Be concise but thorough
   - Explain complex changes
   - Use the todo list for multi-step tasks

4. **Quality Standards**
   - Every feature should be production-ready
   - Include proper error handling
   - Add security measures by default
   - Follow existing code patterns

5. **Development Flow**
   - Database schema first
   - Backend logic second
   - Frontend UI last
   - Test everything

Remember: This is a Claude Code-first starter. Users expect fast, high-quality development with AI assistance. Deliver on that promise.