# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a full-stack web application template built with:
- **Frontend**: Vanilla JavaScript/HTML/CSS (no build process)
- **Backend**: Supabase Edge Functions (Deno runtime)
- **Database**: PostgreSQL via Supabase
- **Hosting**: Cloudflare Pages (frontend), Supabase (backend)
- **Authentication**: Magic link email authentication

## Key Commands

```bash
# Initial setup (run once)
cp setup-env.sh.template setup-env.sh
# Edit setup-env.sh with your Supabase and Cloudflare credentials
source setup-env.sh dev  # or prod

# Database setup (run once)
# Execute sql/schema.sql content in Supabase SQL editor

# Deploy backend (Supabase Edge Functions)
./deploy_backend.sh

# Deploy frontend (Cloudflare Pages)
./deploy_frontend.sh

# Local development
# Frontend: Open frontend/index.html in browser or use a local server
# Backend: Test edge functions via Supabase dashboard or curl

# Deploy specific function (for testing)
supabase functions deploy <function-name> --project-ref $SUPABASE_PROJECT_REF
```

## Architecture

### Directory Structure
```
template/
├── frontend/               # Frontend application
│   ├── index.html         # Main application (requires authentication)
│   ├── login.html         # Login page
│   ├── index.js           # Main app logic
│   ├── auth.js            # Authentication utilities
│   ├── supabase.js        # Supabase client
│   ├── style.css          # Styles
│   └── env.js             # Environment variables (generated)
├── supabase/
│   ├── functions/         # Edge functions
│   │   ├── _shared/       # Shared utilities
│   │   │   └── cors.ts    # CORS configuration
│   │   ├── hello-world/   # Example public endpoint
│   │   └── protected-endpoint/ # Example authenticated endpoint
│   └── config.toml        # Supabase configuration
├── sql/
│   └── schema.sql         # Database schema
├── deploy_backend.sh      # Backend deployment script
├── deploy_frontend.sh     # Frontend deployment script
├── setup-env.sh.template  # Environment setup template
├── CLAUDE.md             # This file
└── README.md             # Setup instructions
```

### Page Structure

**Simple two-page architecture:**
- `index.html` - The MAIN APPLICATION (requires authentication)
- `login.html` - The authentication page

**Authentication Flow:**
1. User visits site → redirected to `login.html` if not authenticated
2. User logs in → redirected to `index.html` (main app)
3. All app functionality lives in `index.html`

**When users ask you to build features:**
- ✅ ALWAYS modify `index.html` and `index.js` for app functionality
- ✅ Update schema.sql for database changes
- ✅ Create edge functions for backend logic
- ❌ NEVER create app.html or other HTML files unless specifically requested

### CRITICAL: The env.js File

**IMPORTANT**: The app requires `env.js` to be present with Supabase configuration. This file is:
- Generated by `deploy_frontend.sh` 
- Contains `window.SUPABASE_URL` and `window.SUPABASE_ANON_KEY`
- Required for the app to connect to Supabase

**If the user reports Supabase errors**, check if env.js exists:
```javascript
// env.js should contain:
window.SUPABASE_URL = 'https://xyzabc.supabase.co';
window.SUPABASE_ANON_KEY = 'eyJ...';
```

**For local development**, create env.js manually or run the deploy script.

### Key Patterns

1. **Authentication Flow**
   - User enters email on login page
   - Magic link sent via Supabase Auth
   - User clicks link and is authenticated
   - Session stored in localStorage
   - Auth state changes trigger navigation

2. **Frontend Patterns**
   - Modular JavaScript with clear separation of concerns
   - Global auth state management via window.authReady
   - Event-driven communication between modules
   - Realtime subscriptions for live updates
   - No build process - pure vanilla JS

3. **Backend Patterns**
   - Edge functions follow consistent structure
   - CORS handling in _shared/cors.ts
   - Authentication verification via JWT
   - Proper error responses with status codes
   - Admin client for privileged operations

4. **Database Patterns**
   - UUID primary keys
   - Row Level Security (RLS) policies
   - Audit fields (created_at, updated_at, created_by)
   - User roles (user, admin)
   - Soft delete pattern where appropriate
   - **Idempotent schema**: setup_database.sh drops and recreates tables

5. **Security Best Practices**
   - Never expose API keys in frontend
   - Use environment variables for secrets
   - Implement RLS policies for all tables
   - Verify authentication in edge functions
   - Use admin client only when necessary

### Script Loading Order in HTML Files

**CRITICAL**: Always include scripts in this exact order:
```html
<!-- At the bottom of your HTML file, before </body> -->
<script src="env.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="auth.js"></script>
<script src="index.js"></script>  <!-- or your page-specific script -->
```

**Why this order matters:**
1. `env.js` - Sets up environment variables (MUST be first)
2. Supabase CDN - Provides the Supabase library
3. `supabase.js` - Creates the Supabase client
4. `auth.js` - Sets up authentication
5. Your app logic - Can now use everything above

### Adding New Features

1. **New Page (rarely needed)**
   - Most features should be added to index.html
   - Only create new pages if specifically requested
   - Update auth.js routing if adding pages

2. **New Edge Function**
   - Create folder in supabase/functions/
   - Copy structure from hello-world or protected-endpoint
   - Import CORS from _shared/cors.ts
   - Deploy with deploy_backend.sh

3. **New Database Table**
   - Add to sql/schema.sql
   - Include RLS policies
   - Add indexes for performance
   - Enable realtime if needed

4. **Environment Variables**
   - Add to setup-env.sh.template
   - Document in README.md
   - Use in code via env.js (frontend) or Deno.env (backend)

### Common User Requests and How to Handle Them

1. **"Build a [todo/notes/task/etc] app"**
   - Modify `index.html` and `index.js` for the app UI
   - Update schema.sql with appropriate tables
   - Create edge functions for CRUD operations
   - Add realtime subscriptions if needed

2. **"Add user profiles"**
   - Create profiles table in schema.sql
   - Add RLS policies for security
   - Update index.html with profile UI
   - Create profile management edge functions

3. **"Add file uploads"**
   - Use Supabase Storage buckets
   - Create storage policies
   - Add upload UI to index.html
   - Handle file metadata in database

4. **"Add payment processing"**
   - Integrate Stripe via edge functions
   - Add subscription/payment tables
   - Create checkout flow in index.html
   - Handle webhooks securely

5. **"Make it real-time"**
   - Enable realtime on relevant tables
   - Add subscription handlers in index.js
   - Update UI reactively on changes

### Common Implementation Patterns

1. **Check Authentication Status**
   ```javascript
   const user = await window.requireAuth();  // Will redirect to login if not authenticated
   // Or just get current user:
   const currentUser = window.getCurrentUser();
   ```

2. **Make Authenticated API Call**
   ```javascript
   // Edge functions are available globally
   const result = await window.invokeEdgeFunction('your-function-name', { data: 'value' });
   ```

3. **Database Operations**
   ```javascript
   // All database functions are available globally
   const items = await window.selectFrom('items');
   const newItem = await window.insertInto('items', { name: 'New Item' });
   await window.updateIn('items', itemId, { name: 'Updated' });
   await window.deleteFrom('items', itemId);
   ```

4. **Subscribe to Realtime Updates**
   ```javascript
   const channel = window.subscribeToTable('items', (payload) => {
     console.log('Change:', payload);
     // Update UI based on change
   });
   ```

5. **Add RLS Policy**
   ```sql
   CREATE POLICY "Users can view own items" ON items
     FOR SELECT USING (auth.uid() = user_id);
   ```

### Testing

- Frontend: Use browser developer tools and console
- Backend: Test via Supabase dashboard or curl commands
- Database: Use Supabase SQL editor for queries
- Authentication: Create test users via Supabase dashboard

### Deployment

1. Always run `source setup-env.sh <env>` before deploying
2. Deploy backend first with `./deploy_backend.sh`
3. Deploy frontend with `./deploy_frontend.sh`
4. Monitor logs in Supabase and Cloudflare dashboards

### Troubleshooting

- **Auth issues**: Check Supabase Auth settings and email templates
- **CORS errors**: Verify frontend URL in CORS configuration
- **Database errors**: Check RLS policies and user permissions
- **Function errors**: View logs in Supabase dashboard
- **Environment issues**: Ensure setup-env.sh is sourced correctly

# Important Claude Code Guidelines

1. **User Intent is King**
   - Build exactly what the user asks for
   - Don't add features they didn't request
   - Ask for clarification when needed

2. **File Management**
   - Edit existing files when possible
   - Only create new files for new features
   - Follow the established structure

3. **Communication**
   - Be concise but thorough
   - Explain complex changes
   - Use the todo list for multi-step tasks

4. **Quality Standards**
   - Every feature should be production-ready
   - Include proper error handling
   - Add security measures by default
   - Follow existing code patterns

5. **Development Flow**
   - Database schema first
   - Backend logic second
   - Frontend UI last
   - Test everything

Remember: This is a Claude Code-first starter. Users expect fast, high-quality development with AI assistance. Deliver on that promise.