#!/bin/bash

# Environment Setup Script
# Copy this to setup-env.sh and fill in your values below

# === YOUR CONFIGURATION - EDIT THESE VALUES ===

# Supabase
export SUPABASE_PROJECT_REF="YOUR_PROJECT_REF"
export SUPABASE_ANON_KEY="YOUR_ANON_KEY"
export SUPABASE_SERVICE_ROLE_KEY="YOUR_SERVICE_ROLE_KEY"
export SUPABASE_DB_PASSWORD="YOUR_DB_PASSWORD"
export SUPABASE_ACCESS_TOKEN="YOUR_SUPABASE_ACCESS_TOKEN"

# Cloudflare
export CLOUDFLARE_ACCOUNT_ID="YOUR_CLOUDFLARE_ACCOUNT_ID"
export CLOUDFLARE_API_TOKEN="YOUR_CLOUDFLARE_API_TOKEN"
export CLOUDFLARE_PROJECT_NAME="your-app-name"

# OpenAI
export OPENAI_API_KEY="YOUR_OPENAI_API_KEY"

# === END OF CONFIGURATION ===

# Derive Supabase URL from project ref
export SUPABASE_URL="https://${SUPABASE_PROJECT_REF}.supabase.co"

# Validation
REQUIRED_VARS=(
    "SUPABASE_URL"
    "SUPABASE_ANON_KEY"
    "SUPABASE_PROJECT_REF"
    "SUPABASE_DB_PASSWORD"
    "SUPABASE_ACCESS_TOKEN"
    "CLOUDFLARE_ACCOUNT_ID"
    "CLOUDFLARE_API_TOKEN"
    "CLOUDFLARE_PROJECT_NAME"
    "OPENAI_API_KEY"
)

echo "Checking environment variables..."
ALL_SET=true
for var in "${REQUIRED_VARS[@]}"; do
    eval "value=\$$var"
    if [ -z "$value" ] || echo "$value" | grep -q "YOUR_"; then
        echo "❌ $var is not properly set"
        ALL_SET=false
    else
        echo "✅ $var is set"
    fi
done

if [ "$ALL_SET" = true ]; then
    echo ""
    echo "✅ Environment setup complete!"
    echo ""
    echo "Supabase Project: $SUPABASE_PROJECT_REF"
    echo "Cloudflare Project: $CLOUDFLARE_PROJECT_NAME"
    
    # Generate env.js for frontend
    echo ""
    echo "Generating frontend/env.js..."
    cat > frontend/env.js <<EOF
// Environment configuration
// Auto-generated by setup-env.sh - DO NOT EDIT
window.SUPABASE_URL = '${SUPABASE_URL}';
window.SUPABASE_ANON_KEY = '${SUPABASE_ANON_KEY}';
EOF
    echo "✅ frontend/env.js created"
    
    # Link Supabase project
    if command -v supabase &> /dev/null; then
        echo ""
        echo "Linking Supabase project..."
        supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD" 2>&1 | grep -v "WARNING: Local config differs" || true
    fi
    
    echo ""
    echo "Next steps:"
    echo "  1. Run: ./setup_database.sh"
    echo "  2. Run: ./deploy_backend.sh"
    echo "  3. Run: ./deploy_frontend.sh"
else
    echo ""
    echo "❌ Please update setup-env.sh with your actual values"
fi