#!/bin/bash

# Environment Setup Script
# This script loads configuration from env.config
# Copy this to setup-env.sh (no need to edit this file)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if env.config exists
if [ ! -f "env.config" ]; then
    echo -e "${RED}Error: env.config not found!${NC}"
    echo -e "${YELLOW}Please copy env.config.template to env.config and fill in your values:${NC}"
    echo "  cp env.config.template env.config"
    echo "  # Edit env.config with your credentials"
    return 1 2>/dev/null || exit 1
fi

# Source the configuration
source env.config

# Derive SUPABASE_URL from PROJECT_REF
export SUPABASE_URL="https://${SUPABASE_PROJECT_REF}.supabase.co"

# Auto-fetch Cloudflare Account ID from API token
if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
    echo -e "${GREEN}Auto-fetching Cloudflare Account ID from API...${NC}"
    
    if command -v curl &> /dev/null; then
        API_RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" 2>/dev/null)
        
        if echo "$API_RESPONSE" | grep -q '"success":true'; then
            CLOUDFLARE_ACCOUNT_ID=$(echo "$API_RESPONSE" | python3 -c "import json, sys; data=json.load(sys.stdin); print(data['result'][0]['id'])" 2>/dev/null)
            
            if [ -n "$CLOUDFLARE_ACCOUNT_ID" ]; then
                echo -e "${GREEN}✅ Account ID: $CLOUDFLARE_ACCOUNT_ID${NC}"
                export CLOUDFLARE_ACCOUNT_ID
            else
                echo -e "${RED}❌ Failed to parse Account ID from API response${NC}"
                return 1 2>/dev/null || exit 1
            fi
        else
            echo -e "${RED}❌ API call failed. Please check your CLOUDFLARE_API_TOKEN${NC}"
            return 1 2>/dev/null || exit 1
        fi
    else
        echo -e "${RED}❌ curl not available for API call${NC}"
        return 1 2>/dev/null || exit 1
    fi
fi

# Export all variables for use by other scripts
export SUPABASE_PROJECT_REF
export SUPABASE_URL
export SUPABASE_ANON_KEY
export SUPABASE_SERVICE_ROLE_KEY
export SUPABASE_DB_PASSWORD
export SUPABASE_ACCESS_TOKEN
export CLOUDFLARE_ACCOUNT_ID
export CLOUDFLARE_PROJECT_NAME
export OPENAI_API_KEY

# Validation
REQUIRED_VARS=(
    "SUPABASE_URL"
    "SUPABASE_ANON_KEY"
    "SUPABASE_PROJECT_REF"
    "SUPABASE_DB_PASSWORD"
    "SUPABASE_SERVICE_ROLE_KEY"
    "SUPABASE_ACCESS_TOKEN"
    "CLOUDFLARE_API_TOKEN"
    "CLOUDFLARE_ACCOUNT_ID"
    "CLOUDFLARE_PROJECT_NAME"
    "OPENAI_API_KEY"
)

echo -e "${GREEN}Checking environment variables...${NC}"
ALL_SET=true
MISSING_VARS=()
for var in "${REQUIRED_VARS[@]}"; do
    eval "value=\$$var"
    if [ -z "$value" ] || [[ "$value" == *"your-"*"here"* ]]; then
        MISSING_VARS+=("$var")
        ALL_SET=false
    fi
done

if [ "$ALL_SET" = false ]; then
    echo -e "${RED}Error: Missing or unconfigured environment variables:${NC}"
    for var in "${MISSING_VARS[@]}"; do
        echo "  - $var"
    done
    echo -e "\n${YELLOW}Please edit env.config and set all required values${NC}"
    return 1 2>/dev/null || exit 1
fi

if [ "$ALL_SET" = true ]; then
    echo -e "\n${GREEN}✅ Environment setup complete!${NC}"
    echo -e "${GREEN}Supabase Project: $SUPABASE_PROJECT_REF${NC}"
    echo -e "${GREEN}Cloudflare Project: $CLOUDFLARE_PROJECT_NAME${NC}"
    
    # Generate env.js for frontend
    echo -e "\n${GREEN}Generating frontend/env.js...${NC}"
    cat > frontend/env.js <<EOF
// Environment configuration
// Auto-generated by setup-env.sh - DO NOT EDIT
window.SUPABASE_URL = '${SUPABASE_URL}';
window.SUPABASE_ANON_KEY = '${SUPABASE_ANON_KEY}';
EOF
    echo -e "${GREEN}✅ frontend/env.js created${NC}"
    
    # Link Supabase project
    if command -v supabase &> /dev/null; then
        echo -e "\n${GREEN}Linking Supabase project...${NC}"
        if [ ! -f "supabase/.temp/project-ref" ] || [ "$(cat supabase/.temp/project-ref 2>/dev/null)" != "$SUPABASE_PROJECT_REF" ]; then
            supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD" 2>&1 | grep -v "WARNING: Local config differs" || true
            echo -e "${GREEN}✅ Project linked${NC}"
        else
            echo -e "${GREEN}✅ Already linked to project${NC}"
        fi
    fi
    
    echo -e "\n${GREEN}Next steps:${NC}"
    echo "  1. Setup database: ./setup_database.sh"
    echo "  2. Deploy backend: ./deploy_backend.sh"
    echo "  3. Deploy frontend: ./deploy_frontend.sh"
    echo "  4. Test your setup in the browser"
fi